## Часть 2. Clang static analyzer и CVE-2014-8130
[Clang static analyzer](https://clang-analyzer.llvm.org/) - это статический анализатор на базе компилятора clang, который, в свою очередь, входит в проект LLVM.
Уязвимость CVE-2014-8130 была обнаружена в библиотеке для работы с TIFF-файлами [libtiff](https://gitlab.com/libtiff/libtiff).
Давайте попробуем обнаружить и исправить эту уязвимость, опираясь на статический анализ с помощью clang static analyzer.

В ходе выполнения заданий 2 части у нас должны получиться следующие артефакты работы:
- скриншоты выполнения пунктов задания
- файл, содержащий подготовленный с помощью `git format-patch` патч, испраляющий уязвимость

### Настройка окружения
Поскольку clang static analyzer построен на базе компилятора clang, он позволяет проводить более глубокий анализ программы путем участия в ее сборке. Следовательно, для такого анализа нам потребуется собрать библиотеку libtiff, а значит нам потребуется установить ее зависимости:
```shell
apt-get install make libSM-devel libXi-devel libXmu-devel libfreeglut-devel libjpeg-devel liblzma-devel libwebp-devel libzstd-devel zlib-devel libdeflate-devel
```
 Также установим LLVM и сам clang static analyzer
```shell
apt-get install clang18.1-analyzer gcc-c++ llvm18.1
```
Склонируем себе репозиторий с проектом libtiff и перейдем в его директорию
```shell
git clone (your assignment repo link)
cd (your assignemnt repo)
```

### Статический анализ
В новой версии libtiff рассматриваемая нами уязвимость исправлена. Чтобы проанализировать код, где она еще не была исправлена, откатимся к версии 4.0.3
```shell
git checkout v4.0.3-branch
```
Чтобы провести статический анализ с использованием clang static analyzer, можно использовать утилиту scan-build, которая проведет сборку нашего проекта с необходимыми для статического анализа настройками компилятора. Поскольку наш проект собирается с помощью скрипта `configure` и утилиты `make`, то для сборки со статическим анализом используем следующие команды
```shell
scan-build ./configure
scan-build make -j4
```
Здесь ключ `-j4` запускает сборку в несколько потоков, что позволяет ускорить этот процесс.

### Разбор срабатываний
После завершения работы утилиты scan-build будет выведено сообщение вида
```shell
scan-build: Run 'scan-view /tmp/.private/[..]' to examine bug reports.
```
Запустив указанную команду мы сможем ознакомиться с результатами статического анализа в любом браузере по указанному в выводе команды адресу.

Нас будет интересовать первое срабатывание детектора `Division by zero` в файле `libtiff/tif_write.c:119`.
Как видим, `td->td_stripsperimage` может быть равным нулю, в результате чего может возникнуть деление на ноль.

Для этой уязвимости у нас есть proof of conecpt (PoC) файл - это файл, позволяющий продемонстрировать существование уязвимости. Давайте остановим работу утилиты scan-view (Ctrl+C) и попробуем воспроизвести эксплуатацию уязвимости, для этого подадим на вход собранной нами утилите tiffdither специально сформированный tiff файл, который приведет к рассматриваемому нами делению на ноль. Предварительно любым удобным способом склонируйте PoC файл из репозитория с заданиями.
```shell
./tools/tiffdither <path/to/poc/15_tiffdither.tiff> out.tiff
```
Мы должны увидеть сообщение вида `floating point exception`, свидетельствующего о том, что выполнение программы было прервано указанным исключением.

### Исправление ошибки
Для исправления ошибки можно добавить проверку, равен ли `td->td_stripsperimage` нулю непосредственно перед проведением деления. Проверка может выглядеть следующим образом
```c
if (td->td_stripsperimage == 0) {
	return (-1);
}
```

Самостоятельно проведите указанное или подобное ему исправление, внесите его в систему контроля версий с помощью команд `git add` и `git commit`, а затем повторно запустите статический анализ (для этого потребуется сначала удалить результаты предыдущей сборки с помощью `make clean`). Убедитесь, что рассматриваемое срабатывание больше не появляется, а также что PoC-файл больше не вызывает описанное исключение.

### Подготовка патча
Аналогично первой части необходимо подготовить патч с помощью команды `git format-patch`

### Итог 2 части
В ходе 2 части мы познакомились с clang static analyzer, который позволяет проводить более глубокий анализ за счет участия в сборке программы. Проанализировали уязвимую к CVE-2014-8130 версию библиотеки libtiff, обнаружили данную уязвимость посредством статического анализа, проверили ее наличие с помощью PoC-файла, исправили ее и убедились в отсутствии повторного срабатывания статического анализатора.

Дополнительно:
- Сравните ваше исправление с коммитом, который действительно использовался для исправления этой уязвимости (информацию об уязвимости удобно смотреть по ее идентификатору на https://CVE.org).
