## Часть 3. Svace и CVE-2021-41459
[Svace](https://www.ispras.ru/technologies/svace/) - это статический анализатор, разработанный ИСП РАН. Для выполнения команд анализа (начиная с команды `svace analyze`) требуется приобретенная лицензия на использование Svace, поэтому мы будем использовать прегенерированный снепшот.
Уязвимость CVE-2021-41459 была обнаружена в [GPAC](https://github.com/gpac/gpac) - фреймворке для работы с медиаконтентом.
Обнаружить данную уязвимость с использованием рассмотренных ранее cppcheck и clang static analyzer не получится, давайте попробуем обнаружить ее с помощью Svace.

В ходе выполнения заданий 3 части у нас должны получиться следующие артефакты работы:
- скриншоты выполнения пунктов задания
- `.svace-dir`, получившаяся в результате выполнения команды `svace build`
- файл, содержащий подготовленный с помощью `git format-patch` патч, испраляющий уязвимость

### Настройка окружения
#### Установка и настройка Svace
Скачаем и распакуем архив со статическим анализатором Svace
```shell
curl -LJ -o svace.tar.bz2 'https://nextcloud.ispras.ru/public.php/dav/files/pB8sn5a2bp6BjLP/Svace/svace-4.0.250829-x64-linux.tar.bz2'
tar -xjf svace.tar.bz2
```
Создадим симлинк в PATH, чтобы появилась возможность запускать svace без указания пути
```shell
ln -s ~/svace-4.0.250829-x64-linux/bin/svace /usr/local/bin/svace
```

#### Установка и настройка Svacer
Установим сервер для просмотра результатов разметки Svacer из предоставляемого RPM-пакета
```shell
curl -LJ -o svacer-11.2-0.x86_64.rpm 'https://nextcloud.ispras.ru/public.php/dav/files/pB8sn5a2bp6BjLP/Svace/Svacer/svacer-11.2-0.x86_64.rpm'
sudo apt-get install ./svacer-11.2-0.x86_64.rpm
```
Устанавливаем postgresql с необходимыми расширениями:
```shell
sudo apt-get install postgresql16-server postgresql16-contrib
```
Инициируем базу данных postgresql и запускаем сервис (от имени root)
```shell
/etc/init.d/postgresql initdb
systemctl start postgresql
```
Запускаем утилитку psql под именем пользователя postgres:
```shell
psql -U postgres
```
Внутри psql создаем БД для работы svacer:
```shell
 postgres=# create database svace;
 postgres=# create user svace with encrypted password 'svace';
 postgres=# grant all privileges on database svace to svace;
 postgres=# alter user svace superuser;
 postgres=# CREATE EXTENSION IF NOT EXISTS btree_gin;
```
Для выхода используем Ctrl+D

Запускаем Svacer, например, на порту 8081:
```
svacer-server run --port 8081
```
После этого оставляем запущенным процесс сервера, дальнейшую работу проводим в другом окне

#### Установка GPAC
Клонируем репозиторий GPAC
```shell
git clone <your assignment repo>
```
Самостоятельно с помощью ресурсов с данными об уязвимости CVE-2021-41459 определяем уязвимую версию и переключаемся на неё.

### Статический анализ
```
./configure --static-mp4box --use-zlib=no
```

Инициируем директорию .svace-dir, которая будет использоваться для хранения артефактов статического анализа:
```shell
svace init
```

Запускаем сборку (`make`) под контролем Svace:
```shell
svace build make
```

На этом шаге у нас есть наполненная .svace-dir, но по ней не проведен анализ.
<details>
  <summary>Следующим шагом должен был быть запуск анализа Svace, но на этом шаге требуется наличие лицензии, а ее у нас нет, поэтому можем просто посмотреть на команду, а дальше будем использовать прегенерированный снепшот:</summary>

> Опция `--with-cache` замедляет анализ, но позволяет продолжить "с того же места" в случае прерывания. Можно убрать для ускорения.
> ```shell
> svace analyze --with-cache
> ```
</details>



### Разбор срабатываний и исправление ошибки


<details>
  <summary>Следующую команду мы тоже пропускаем из-за отсутсвия лицензии:</summary>

> Сначала используем внутренний сервер просмотра разметок svace
> ```shell
> svace history import
> svace server single-start
> ```
>После чего по адресу http://127.0.0.1:8060 можно будет посмотреть результаты работы анализатора
>
> Для более удобной работы используем утилиту Svacer, для выполнения команды upload требуется ранее запущенный сервер Svacer
> ```shell
> svacer import
> svacer upload --port 8081
> ```
</details>

Теперь по адресу  http://127.0.0.1:8081 можно будет подключиться к Svacer с логином и паролем admin:admin

Загрузим заранее подготовленный снепшот - gpac.snap. Загрузка снепшотов через Проекты -> Новый проект -> Импорт -> снимок (*.snap)

Самостоятельно с помощью ресурсов с данными об уязвимости CVE-2021-41459 найдите детектор, сработавший на рассматриваемую ошибку.

Для этой уязвимости также есть PoC-файл, проверьте с его помощью существование уязвимости:
```shell
gpac/bin/gcc/MP4Box -add poc.nhml -new new.mp4
```

Самостоятельно с помощью ресурсов с данными об уязвимости CVE-2021-41459 подготовьте патч с исправлением ошибки (можно использовать `git cherry-pick` с исправляющим коммитом из апстрима), убедитесь, что PoC-файл больше не вызывает исключение, а также, что статический анализ не вызывает сработку ранее указанного детектора.

### Итог 3 части
В ходе 3 части мы познакомились с Svace. Проанализировали уязвимую к CVE-2021-41459 версию GPAC, обнаружили данную уязвимость посредством статического анализа, проверили ее наличие с помощью PoC-файла, исправили ее и убедились в отсутствии повторного срабатывания статического анализатора.

Дополнительно:
- Попробуете обнаружить эту уязвимость с помощью других средств статического анализа. Предположите, почему получается/не получается.
